name: Docker Image CD

on:
    push:
        branches: ['main']
    workflow_dispatch:

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3
            - name: Docker build and push
              uses: cloudposse/github-action-docker-build-push@1.13.0
              with:
                  build-args: |
                      COMMIT_HASH=${{ github.sha }}
                  workdir: ./backend
                  registry: registry.hub.docker.com
                  organization: nidib
                  repository: bloquinho-api
                  login: '${{ secrets.DOCKER_USERNAME }}'
                  password: '${{ secrets.DOCKER_PASSWORD }}'
                  platforms: linux/amd64
            - name: Trigger CapRrover build
              uses: caprover/deploy-from-github@v1.1.2
              with:
                server: "${{ secrets.CAP_ROVER_SERVER }}"
                app: "${{ secrets.CAP_ROVER_APP_NAME }}"
                token: "${{ secrets.CAP_ROVER_APP_TOKEN }}"
                image: ${{ env.DOCKER_HUB_IMAGE_URL }}
