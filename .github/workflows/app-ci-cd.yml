name: CI

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

on:
    pull_request:
    release:
        types: [published]
    push:
        branches:
            - main
    workflow_dispatch:
        inputs:
            deployment_target:
                description: 'Deployment Target'
                required: true
                default: 'preview'
                type: choice
                options:
                    - preview
                    - production

jobs:
    compile:
        runs-on: ubuntu-latest
        env:
            MONGO_DB_URL: mongodb://username:password@localhost:27017

        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Setup PNPM
              uses: pnpm/action-setup@v4
              with:
                  version: 10.12.3
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version-file: .nvmrc
                  cache: pnpm
            - name: Install Dependencies
              run: pnpm install
            - name: Lint Code
              run: pnpm lint
            - name: Compile TypeScript
              run: pnpm compile

    deploy:
        name: Deploy to ${{ github.event.inputs.deployment_target }}
        runs-on: ubuntu-latest
        needs: compile
        if: github.event_name == 'workflow_dispatch' || github.event_name == 'release'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Setup PNPM
              uses: pnpm/action-setup@v4
              with:
                  version: 10.12.3
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version-file: .nvmrc
                  cache: pnpm
            - name: Install Dependencies
              run: pnpm install
            - name: Install Vercel CLI
              run: pnpm install -g vercel@latest
            - name: Build web app
              run: cd apps/web && vercel deploy --yes --target=${{ github.event.inputs.deployment_target }} --token=${{ secrets.VERCEL_TOKEN }}